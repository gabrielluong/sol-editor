<!DOCTYPE html><html lang="en"><head><title>app/file_handlers/renderer/helpers/controls</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../../"><meta name="groc-document-path" content="app/file_handlers/renderer/helpers/controls"><meta name="groc-project-path" content="app/file_handlers/renderer/helpers/controls.js"><link rel="stylesheet" type="text/css" media="all" href="../../../../assets/style.css"><script type="text/javascript" src="../../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/file_handlers/renderer/helpers/controls.js</div></div><div id="document"><div class="segment"><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span> <span class="p">()</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>// -----------------------------------------------------------------------------
 // -----------------------------------------------------------------------------
 // --
 // -- File Name: app.js
 // --
 // -- Author: Paul Nispel
 // --
 // -----------------------------------------------------------------------------
 // -- History:
 // **
 // -- PMN - 1/18/14 - Baseline
 // --
 // -----------------------------------------------------------------------------
 // -- Copyright 2014 Skwintz
 // -----------------------------------------------------------------------------</p></div></div><div class="code"><div class="wrapper"><span class="kd">var</span> <span class="nx">_cache</span> <span class="o">=</span> <span class="p">{};</span>

<span class="kd">var</span> <span class="nx">service</span> <span class="o">=</span> <span class="nx">angular</span><span class="p">.</span><span class="nx">module</span><span class="p">(</span> <span class="s1">&#39;service.controls&#39;</span><span class="p">,</span> <span class="p">[</span>
  <span class="s1">&#39;service.signals&#39;</span><span class="p">,</span>
  <span class="s1">&#39;service.navigator&#39;</span>
<span class="p">]);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper"><span class="nx">service</span><span class="p">.</span><span class="nx">factory</span><span class="p">(</span> <span class="s1">&#39;Controls&#39;</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">Signals</span><span class="p">,</span> <span class="nx">Navigator</span><span class="p">)</span> <span class="p">{</span>

  <span class="kd">function</span> <span class="nx">Controls</span> <span class="p">(</span><span class="nx">ctx</span><span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if (_cache[ctx.guid]) return _cache[ctx.guid];</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">guid</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">guid</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">ctx</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">other</span> <span class="o">=</span> <span class="nx">Navigator</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">guid</span><span class="p">).</span><span class="nx">camera</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">camera</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">selectionAxis</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">accessories</span><span class="p">.</span><span class="nx">axis</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">intersectionPlane</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">accessories</span><span class="p">.</span><span class="nx">intersectionPlane</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">domElement</span> <span class="o">=</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">element</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">center</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
    <span class="c1">//this.centerCircle.position = this.center;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">userZoom</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userZoomSpeed</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">userRotate</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userRotateSpeed</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">userPan</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">userPanSpeed</span> <span class="o">=</span> <span class="mf">7.0</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">autoRotate</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">autoRotateSpeed</span> <span class="o">=</span> <span class="mf">2.0</span><span class="p">;</span> <span class="c1">// 30 seconds per round when fps is 60</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">minPolarAngle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="c1">// radians</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">maxPolarAngle</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="p">;</span> <span class="c1">// radians</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">minDistance</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">maxDistance</span> <span class="o">=</span> <span class="kc">Infinity</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">keys</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">LEFT</span><span class="o">:</span> <span class="mi">37</span><span class="p">,</span> <span class="nx">UP</span><span class="o">:</span> <span class="mi">38</span><span class="p">,</span> <span class="nx">RIGHT</span><span class="o">:</span> <span class="mi">39</span><span class="p">,</span> <span class="nx">BOTTOM</span><span class="o">:</span> <span class="mi">40</span> <span class="p">};</span>

    <span class="nx">_cache</span><span class="p">[</span><span class="k">this</span><span class="p">.</span><span class="nx">guid</span><span class="p">]</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">EPS</span> <span class="o">=</span> <span class="mf">0.000001</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">PIXELS_PER_ROUND</span> <span class="o">=</span> <span class="mi">1800</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">rotateStart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector2</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">rotateEnd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector2</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">rotateDelta</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector2</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">zoomStart</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector2</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">zoomEnd</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector2</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">zoomDelta</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector2</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">phiDelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">phi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">thetaDelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">theta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">lastPosition</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">STATE</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">NONE</span><span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nx">ROTATE</span><span class="o">:</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">ZOOM</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">PAN</span><span class="o">:</span> <span class="mi">2</span> <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">state</span> <span class="o">=</span> <span class="nx">STATE</span><span class="p">.</span><span class="nx">NONE</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>events</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">changeEvent</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;change&#39;</span> <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">rotateTo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">angle</span> <span class="p">)</span> <span class="p">{</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">rotateLeft</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">angle</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">angle</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">angle</span> <span class="o">=</span> <span class="nx">getAutoRotationAngle</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="nx">thetaDelta</span> <span class="o">-=</span> <span class="nx">angle</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">rotateRight</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">angle</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">angle</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">angle</span> <span class="o">=</span> <span class="nx">getAutoRotationAngle</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="nx">thetaDelta</span> <span class="o">+=</span> <span class="nx">angle</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">rotateUp</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">angle</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">angle</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">angle</span> <span class="o">=</span> <span class="nx">getAutoRotationAngle</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="nx">phiDelta</span> <span class="o">-=</span> <span class="nx">angle</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">rotateDown</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">angle</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">angle</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">angle</span> <span class="o">=</span> <span class="nx">getAutoRotationAngle</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="nx">phiDelta</span> <span class="o">+=</span> <span class="nx">angle</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">zoomIn</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">zoomScale</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">zoomScale</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">zoomScale</span> <span class="o">=</span> <span class="nx">getZoomScale</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="nx">scale</span> <span class="o">/=</span> <span class="nx">zoomScale</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">zoomOut</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">zoomScale</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">zoomScale</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">zoomScale</span> <span class="o">=</span> <span class="nx">getZoomScale</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="nx">scale</span> <span class="o">*=</span> <span class="nx">zoomScale</span><span class="p">;</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">pan</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">distance</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">distance</span><span class="p">.</span><span class="nx">transformDirection</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">matrix</span> <span class="p">);</span>
      <span class="c1">//distance.multiplyScalar( scope.userPanSpeed );</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">distance</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">center</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">distance</span> <span class="p">);</span>

    <span class="p">};</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">position</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="nx">position</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">sub</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">center</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>angle from z-axis around y-axis</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">theta</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">z</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">theta</span> <span class="o">=</span> <span class="nx">theta</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>angle from y-axis</p></div></div><div class="code"><div class="wrapper">      <span class="kd">var</span> <span class="nx">phi</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span> <span class="o">+</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">z</span> <span class="p">),</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">autoRotate</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">this</span><span class="p">.</span><span class="nx">rotateLeft</span><span class="p">(</span> <span class="nx">getAutoRotationAngle</span><span class="p">()</span> <span class="p">);</span>

      <span class="p">}</span>

      <span class="nx">theta</span> <span class="o">+=</span> <span class="nx">thetaDelta</span><span class="p">;</span>
      <span class="nx">phi</span> <span class="o">+=</span> <span class="nx">phiDelta</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>restrict phi to be between desired limits</p></div></div><div class="code"><div class="wrapper">      <span class="nx">phi</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">minPolarAngle</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxPolarAngle</span><span class="p">,</span> <span class="nx">phi</span> <span class="p">)</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>restrict phi to be betwee EPS and PI-EPS</p></div></div><div class="code"><div class="wrapper">      <span class="nx">phi</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="nx">EPS</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">-</span> <span class="nx">EPS</span><span class="p">,</span> <span class="nx">phi</span> <span class="p">)</span> <span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">phi</span> <span class="o">=</span> <span class="nx">phi</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">radius</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">length</span><span class="p">()</span> <span class="o">*</span> <span class="nx">scale</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>restrict radius to be between desired limits</p></div></div><div class="code"><div class="wrapper">      <span class="nx">radius</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">minDistance</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">min</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">maxDistance</span><span class="p">,</span> <span class="nx">radius</span> <span class="p">)</span> <span class="p">);</span>

      <span class="kd">var</span> <span class="nx">partRadius</span> <span class="o">=</span> <span class="nx">radius</span><span class="o">/</span><span class="mi">120</span><span class="p">;</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>if ( partRadius &lt; 1 ) { partRadius = 1; }</p></div></div><div class="code"><div class="wrapper">      <span class="k">this</span><span class="p">.</span><span class="nx">selectionAxis</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">partRadius</span><span class="p">,</span><span class="nx">partRadius</span><span class="p">,</span><span class="nx">partRadius</span> <span class="p">);</span>
      <span class="c1">//this.centerCircle.scale.set( partRadius,partRadius,partRadius );</span>

      <span class="kd">var</span> <span class="nx">otherRadius</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">otherOffset</span> <span class="o">=</span> <span class="nx">offset</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>

      <span class="nx">otherOffset</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">phi</span> <span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">theta</span> <span class="p">);</span>
      <span class="nx">otherOffset</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span> <span class="nx">phi</span> <span class="p">);</span>
      <span class="nx">otherOffset</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mi">200</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">phi</span> <span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span> <span class="nx">theta</span> <span class="p">);</span>

      <span class="nx">offset</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">radius</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">phi</span> <span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">theta</span> <span class="p">);</span>
      <span class="nx">offset</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">radius</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span> <span class="nx">phi</span> <span class="p">);</span>
      <span class="nx">offset</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">radius</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">phi</span> <span class="p">)</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span> <span class="nx">theta</span> <span class="p">);</span>

      <span class="nx">position</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">center</span> <span class="p">).</span><span class="nx">add</span><span class="p">(</span> <span class="nx">offset</span> <span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">other</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)).</span><span class="nx">add</span><span class="p">(</span> <span class="nx">otherOffset</span> <span class="p">);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">other</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">center</span> <span class="p">);</span>

      <span class="nx">thetaDelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">phiDelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">lastPosition</span><span class="p">.</span><span class="nx">distanceTo</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>this.dispatchEvent( changeEvent );</p></div></div><div class="code"><div class="wrapper">        <span class="nx">lastPosition</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>

      <span class="p">}</span>

      <span class="c1">//this.centerCircle.lookAt( this.object.position );</span>

    <span class="p">};</span>


    <span class="kd">function</span> <span class="nx">getAutoRotationAngle</span><span class="p">()</span> <span class="p">{</span>

      <span class="k">return</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">/</span> <span class="mi">60</span> <span class="o">*</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">autoRotateSpeed</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">getZoomScale</span><span class="p">()</span> <span class="p">{</span>

      <span class="k">return</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">pow</span><span class="p">(</span> <span class="mf">0.95</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">userZoomSpeed</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="kd">var</span> <span class="nx">projector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Projector</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">ray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Raycaster</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">lastPos</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>

    <span class="kd">function</span> <span class="nx">getMouseCoord</span><span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">vector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span>
        <span class="p">(</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageX</span> <span class="o">-</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">domElement</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">left</span> <span class="p">)</span> <span class="o">/</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">domElement</span><span class="p">.</span><span class="nx">width</span><span class="p">()</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="o">-</span><span class="p">(</span> <span class="p">(</span> <span class="nx">e</span><span class="p">.</span><span class="nx">pageY</span> <span class="o">-</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">domElement</span><span class="p">.</span><span class="nx">offset</span><span class="p">().</span><span class="nx">top</span> <span class="p">)</span> <span class="o">/</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">domElement</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
        <span class="mf">0.5</span>
      <span class="p">);</span>

      <span class="nx">projector</span><span class="p">.</span><span class="nx">unprojectVector</span><span class="p">(</span> <span class="nx">vector</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span> <span class="p">);</span>

      <span class="nx">ray</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">,</span> <span class="nx">vector</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span> <span class="p">).</span><span class="nx">normalize</span><span class="p">()</span> <span class="p">);</span>

      <span class="kd">var</span> <span class="nx">intersects</span> <span class="o">=</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">intersectObject</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">intersectionPlane</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">intersects</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">return</span> <span class="nx">intersects</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">point</span><span class="p">;</span>

      <span class="p">}</span>

      <span class="k">return</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onMouseDown</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">$</span><span class="p">(</span><span class="s2">&quot;#center&quot;</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="s2">&quot;tabindex&quot;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">).</span><span class="nx">focus</span><span class="p">();</span>

      <span class="nx">scope</span><span class="p">.</span><span class="nx">intersectionPlane</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>scope.intersectionPlane.position.copy( scope.center );</p></div></div><div class="code"><div class="wrapper">      <span class="nx">lastPos</span> <span class="o">=</span> <span class="nx">getMouseCoord</span><span class="p">(</span> <span class="nx">event</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">userRotate</span> <span class="p">)</span> <span class="p">{</span><span class="k">return</span><span class="p">;}</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">event</span><span class="p">.</span><span class="nx">button</span> <span class="o">!==</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">command</span> <span class="p">)</span> <span class="p">{</span>
        <span class="nx">state</span> <span class="o">=</span> <span class="nx">STATE</span><span class="p">.</span><span class="nx">ROTATE</span><span class="p">;</span>

        <span class="nx">rotateStart</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">ctx</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">control</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">state</span> <span class="o">=</span> <span class="nx">STATE</span><span class="p">.</span><span class="nx">PAN</span><span class="p">;</span>

      <span class="p">}</span>

      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">onMouseMove</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">onMouseUp</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onMouseMove</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">STATE</span><span class="p">.</span><span class="nx">ROTATE</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">rotateEnd</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="p">);</span>
        <span class="nx">rotateDelta</span><span class="p">.</span><span class="nx">subVectors</span><span class="p">(</span> <span class="nx">rotateEnd</span><span class="p">,</span> <span class="nx">rotateStart</span> <span class="p">);</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">rotateLeft</span><span class="p">(</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">rotateDelta</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">PIXELS_PER_ROUND</span> <span class="o">*</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">userRotateSpeed</span> <span class="p">);</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">rotateUp</span><span class="p">(</span> <span class="mi">2</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="o">*</span> <span class="nx">rotateDelta</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">PIXELS_PER_ROUND</span> <span class="o">*</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">userRotateSpeed</span> <span class="p">);</span>

        <span class="nx">rotateStart</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">rotateEnd</span> <span class="p">);</span>

        <span class="nx">ctx</span><span class="p">.</span><span class="nx">accessories</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">STATE</span><span class="p">.</span><span class="nx">ZOOM</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">zoomEnd</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientX</span><span class="p">,</span> <span class="nx">event</span><span class="p">.</span><span class="nx">clientY</span> <span class="p">);</span>
        <span class="nx">zoomDelta</span><span class="p">.</span><span class="nx">subVectors</span><span class="p">(</span> <span class="nx">zoomEnd</span><span class="p">,</span> <span class="nx">zoomStart</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">zoomDelta</span><span class="p">.</span><span class="nx">y</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

          <span class="nx">scope</span><span class="p">.</span><span class="nx">zoomIn</span><span class="p">();</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

          <span class="nx">scope</span><span class="p">.</span><span class="nx">zoomOut</span><span class="p">();</span>

        <span class="p">}</span>

        <span class="nx">zoomStart</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">zoomEnd</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">state</span> <span class="o">===</span> <span class="nx">STATE</span><span class="p">.</span><span class="nx">PAN</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">handlePan</span><span class="p">(</span> <span class="nx">event</span> <span class="p">);</span>
        <span class="nx">event</span><span class="p">.</span><span class="nx">stopPropagation</span><span class="p">();</span>
        <span class="c1">//var newPanPos = BRANDY._editor.getMouseRayPoint( event.clientX, event.clientY );</span>
        <span class="c1">//var panDiff = lastPanPos.sub( newPanPos );</span>
        <span class="c1">//lastPanPos = newPanPos;</span>

        <span class="c1">//scope.pan( new THREE.Vector3( panDiff.x, panDiff.y, 0 ) );</span>

      <span class="p">}</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">handlePan</span> <span class="p">(</span> <span class="nx">e</span> <span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">newPos</span> <span class="o">=</span> <span class="nx">getMouseCoord</span><span class="p">(</span> <span class="nx">e</span> <span class="p">);</span>

      <span class="kd">var</span> <span class="nx">diff</span> <span class="o">=</span> <span class="nx">lastPos</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">newPos</span> <span class="p">);</span>

      <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">divideScalar</span><span class="p">(</span><span class="mf">1.3</span><span class="p">)</span> <span class="p">);</span>
      <span class="nx">scope</span><span class="p">.</span><span class="nx">center</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">diff</span><span class="p">.</span><span class="nx">divideScalar</span><span class="p">(</span><span class="mf">1.3</span><span class="p">)</span> <span class="p">);</span>

      <span class="nx">lastPos</span> <span class="o">=</span> <span class="nx">newPos</span><span class="p">;</span>

      <span class="c1">//distance.transformDirection( this.object.matrix );</span>
      <span class="c1">//distance.multiplyScalar( scope.userPanSpeed );</span>

      <span class="c1">//this.object.position.add( distance );</span>
      <span class="c1">//this.center.add( distance );</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onMouseUp</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">userRotate</span> <span class="p">)</span> <span class="p">{</span><span class="k">return</span><span class="p">;}</span>

      <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span> <span class="s1">&#39;mousemove&#39;</span><span class="p">,</span> <span class="nx">onMouseMove</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
      <span class="nb">document</span><span class="p">.</span><span class="nx">removeEventListener</span><span class="p">(</span> <span class="s1">&#39;mouseup&#39;</span><span class="p">,</span> <span class="nx">onMouseUp</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

      <span class="nx">state</span> <span class="o">=</span> <span class="nx">STATE</span><span class="p">.</span><span class="nx">NONE</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onMouseWheel</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>
      <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="nx">scope</span><span class="p">.</span><span class="nx">userZoom</span> <span class="p">)</span> <span class="p">{</span><span class="k">return</span><span class="p">;}</span>

      <span class="kd">var</span> <span class="nx">delta</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">originalEvent</span><span class="p">.</span><span class="nx">wheelDelta</span><span class="p">;</span>

      <span class="nx">ctx</span><span class="p">.</span><span class="nx">accessories</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">delta</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">zoomOut</span><span class="p">();</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">zoomIn</span><span class="p">();</span>

      <span class="p">}</span>
    <span class="p">}</span>

    <span class="kd">function</span> <span class="nx">onKeyDown</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">userPan</span> <span class="p">)</span> <span class="p">{</span><span class="k">return</span><span class="p">;}</span>

      <span class="k">switch</span> <span class="p">(</span> <span class="nx">event</span><span class="p">.</span><span class="nx">keyCode</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">case</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">UP</span><span class="o">:</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">pan</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">BOTTOM</span><span class="o">:</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">pan</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">LEFT</span><span class="o">:</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">pan</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="o">-</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">keys</span><span class="p">.</span><span class="nx">RIGHT</span><span class="o">:</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">pan</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">domElement</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mousedown&#39;</span><span class="p">,</span> <span class="nx">onMouseDown</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">domElement</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;mousewheel&#39;</span><span class="p">,</span> <span class="nx">onMouseWheel</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">domElement</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">&#39;keydown&#39;</span><span class="p">,</span> <span class="nx">onKeyDown</span><span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">rotationChanged</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">phi</span><span class="p">,</span> <span class="nx">theta</span> <span class="p">)</span> <span class="p">{</span>
      <span class="kd">var</span> <span class="nx">currentPhi</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">phi</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">currentTheta</span> <span class="o">=</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">theta</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">phiDelta</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">currentPhi</span> <span class="o">-</span> <span class="nx">phi</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">thetaDelta</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span> <span class="nx">currentTheta</span> <span class="o">-</span> <span class="nx">theta</span><span class="p">};</span>

      <span class="kd">var</span> <span class="nx">phiStart</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>
      <span class="kd">var</span> <span class="nx">thetaStart</span> <span class="o">=</span> <span class="p">{</span><span class="nx">x</span><span class="o">:</span><span class="mi">0</span><span class="p">};</span>

      <span class="kd">var</span> <span class="nx">phiLast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="kd">var</span> <span class="nx">thetaLast</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

      <span class="kd">var</span> <span class="nx">phiTween</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TWEEN</span><span class="p">.</span><span class="nx">Tween</span><span class="p">(</span> <span class="nx">phiStart</span> <span class="p">).</span><span class="nx">to</span><span class="p">(</span> <span class="nx">phiDelta</span><span class="p">,</span> <span class="mi">300</span> <span class="p">);</span>

      <span class="kd">var</span> <span class="nx">thetaTween</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">TWEEN</span><span class="p">.</span><span class="nx">Tween</span><span class="p">(</span> <span class="nx">thetaStart</span> <span class="p">).</span><span class="nx">to</span><span class="p">(</span> <span class="nx">thetaDelta</span><span class="p">,</span> <span class="mi">300</span> <span class="p">);</span>

      <span class="nx">phiTween</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">rotateUp</span><span class="p">(</span> <span class="nx">phiStart</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">phiLast</span> <span class="p">);</span>

        <span class="nx">phiLast</span> <span class="o">=</span> <span class="nx">phiStart</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="p">});</span>

      <span class="nx">thetaTween</span><span class="p">.</span><span class="nx">onUpdate</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">rotateLeft</span><span class="p">(</span> <span class="nx">thetaStart</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">thetaLast</span> <span class="p">);</span>

        <span class="nx">thetaLast</span> <span class="o">=</span> <span class="nx">thetaStart</span><span class="p">.</span><span class="nx">x</span><span class="p">;</span>
      <span class="p">});</span>

      <span class="nx">phiTween</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>
      <span class="nx">thetaTween</span><span class="p">.</span><span class="nx">start</span><span class="p">();</span>

      <span class="nx">setInterval</span><span class="p">(</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
        <span class="nx">TWEEN</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
      <span class="p">},</span> <span class="mi">33</span><span class="p">);</span>
    <span class="p">};</span>
  <span class="p">}</span>

  <span class="nx">Controls</span><span class="p">.</span><span class="nx">get</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">guid</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nx">_cache</span><span class="p">[</span><span class="nx">guid</span><span class="p">];</span>
  <span class="p">};</span>

  <span class="k">return</span> <span class="nx">Controls</span><span class="p">;</span>

<span class="p">});</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><hr /></div></div><div class="code"><div class="wrapper"><span class="p">})();</span></div></div></div></div></body></html>