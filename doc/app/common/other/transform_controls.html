<!DOCTYPE html><html lang="en"><head><title>app/common/other/transform_controls</title></head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0"><meta name="groc-relative-root" content="../../../"><meta name="groc-document-path" content="app/common/other/transform_controls"><meta name="groc-project-path" content="app/common/other/transform_controls.js"><link rel="stylesheet" type="text/css" media="all" href="../../../assets/style.css"><script type="text/javascript" src="../../../assets/behavior.js"></script><body><div id="meta"><div class="file-path">app/common/other/transform_controls.js</div></div><div id="document"><div class="segment"><div class="comments doc-section"><div class="wrapper"><p><span class='doc-section-header'> author arodic / https://github.com/arodic</span></p></div></div><div class="code"><div class="wrapper"><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">THREE</span><span class="p">)</span> <span class="p">{</span>
 <span class="s2">&quot;use strict&quot;</span><span class="p">;</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">parameters</span> <span class="p">)</span> <span class="p">{</span>

  <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">depthTest</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">depthWrite</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">side</span> <span class="o">=</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">FrontSide</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setValues</span><span class="p">(</span> <span class="nx">parameters</span> <span class="p">);</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">);</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">parameters</span> <span class="p">)</span> <span class="p">{</span>

  <span class="nx">THREE</span><span class="p">.</span><span class="nx">LineBasicMaterial</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">depthTest</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">depthWrite</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">transparent</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">linewidth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setValues</span><span class="p">(</span> <span class="nx">parameters</span> <span class="p">);</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">LineBasicMaterial</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">);</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mf">0.005</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">]</span>
  <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">showPickers</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">//debug</span>
  <span class="kd">var</span> <span class="nx">showActivePlane</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span> <span class="c1">//debug</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">init</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">picker</span><span class="p">;</span>

    <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">handles</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">lines</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">pickers</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">planes</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">handles</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">pickers</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">);</span>

    <span class="c1">//// PLANES</span>

    <span class="kd">var</span> <span class="nx">planeGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">planeMaterial</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">MeshBasicMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">wireframe</span><span class="o">:</span> <span class="kc">true</span> <span class="p">}</span> <span class="p">);</span>
    <span class="nx">planeMaterial</span><span class="p">.</span><span class="nx">side</span> <span class="o">=</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">DoubleSide</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">planes</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s2">&quot;XY&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">planeGeometry</span><span class="p">,</span> <span class="nx">planeMaterial</span> <span class="p">),</span>
      <span class="s2">&quot;YZ&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">planeGeometry</span><span class="p">,</span> <span class="nx">planeMaterial</span> <span class="p">),</span>
      <span class="s2">&quot;XZ&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">planeGeometry</span><span class="p">,</span> <span class="nx">planeMaterial</span> <span class="p">),</span>
      <span class="s2">&quot;XYZE&quot;</span><span class="o">:</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">planeGeometry</span><span class="p">,</span> <span class="nx">planeMaterial</span> <span class="p">)</span>
    <span class="p">};</span>

    <span class="nx">planes</span><span class="p">.</span><span class="nx">YZ</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="nx">planes</span><span class="p">.</span><span class="nx">XZ</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="nx">i</span> <span class="k">in</span> <span class="nx">planes</span><span class="p">)</span> <span class="p">{</span>
      <span class="nx">planes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">planes</span><span class="p">[</span><span class="nx">i</span><span class="p">]);</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">=</span> <span class="nx">planes</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
      <span class="nx">planes</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="c1">//// HANDLES AND PICKERS</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span> <span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">handle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
      <span class="nx">handle</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">z</span> <span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">].</span><span class="nx">z</span> <span class="p">);</span>

      <span class="k">this</span><span class="p">.</span><span class="nx">handles</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">handle</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span> <span class="o">&amp;&amp;</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">picker</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="p">)</span> <span class="nx">picker</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">].</span><span class="nx">z</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> <span class="nx">picker</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">].</span><span class="nx">x</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">].</span><span class="nx">y</span><span class="p">,</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">2</span><span class="p">].</span><span class="nx">z</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="nx">picker</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>

      <span class="p">}</span>

      <span class="nx">picker</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">pickers</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">picker</span> <span class="p">);</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span> <span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">];</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="nx">i</span><span class="p">;</span>
        <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">line</span> <span class="p">);</span>

      <span class="p">}</span>

    <span class="p">}</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>reset Transformations</p></div></div><div class="code"><div class="wrapper">    <span class="k">this</span><span class="p">.</span><span class="nx">traverse</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">child</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">child</span> <span class="k">instanceof</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">var</span> <span class="nx">tempGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
        <span class="nx">THREE</span><span class="p">.</span><span class="nx">GeometryUtils</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">tempGeometry</span><span class="p">,</span> <span class="nx">child</span> <span class="p">);</span>
        <span class="nx">child</span><span class="p">.</span><span class="nx">geometry</span> <span class="o">=</span> <span class="nx">tempGeometry</span><span class="p">;</span>
        <span class="nx">child</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">child</span><span class="p">.</span><span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
        <span class="nx">child</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

      <span class="p">}</span>
    <span class="p">});</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">hide</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">j</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">j</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">handles</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handles</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">j</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">j</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickers</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickers</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">j</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">show</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>
    <span class="kd">var</span> <span class="nx">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">handles</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">handles</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">lines</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickers</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickers</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">showPickers</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span><span class="p">.</span><span class="nx">visible</span> <span class="o">=</span> <span class="nx">showActivePlane</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">highlight</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">axis</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">handle</span><span class="p">,</span> <span class="nx">line</span><span class="p">,</span> <span class="nx">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">handle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span> <span class="nx">i</span> <span class="p">][</span><span class="mi">0</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldColor</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldColor</span> <span class="p">);</span>
        <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldOpacity</span><span class="p">;</span>

      <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span> <span class="nx">axis</span> <span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">handle</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span><span class="p">[</span> <span class="nx">axis</span> <span class="p">][</span><span class="mi">0</span><span class="p">];</span>

      <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldColor</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
      <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldOpacity</span> <span class="o">=</span> <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span><span class="p">;</span>

      <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">setRGB</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="nx">handle</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span><span class="p">[</span> <span class="nx">i</span> <span class="p">][</span><span class="mi">0</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldColor</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldColor</span> <span class="p">);</span>
        <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldOpacity</span><span class="p">;</span>

      <span class="p">}</span>

    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span><span class="p">[</span> <span class="nx">axis</span> <span class="p">]</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">line</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span><span class="p">[</span> <span class="nx">axis</span> <span class="p">][</span><span class="mi">0</span><span class="p">];</span>

      <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldColor</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">oldOpacity</span> <span class="o">=</span> <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span><span class="p">;</span>

      <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">color</span><span class="p">.</span><span class="nx">setRGB</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
      <span class="nx">line</span><span class="p">.</span><span class="nx">material</span><span class="p">.</span><span class="nx">opacity</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">);</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">rotation</span><span class="p">,</span> <span class="nx">eye</span> <span class="p">)</span> <span class="p">{</span>

  <span class="kd">var</span> <span class="nx">vec1</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">vec2</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">lookAtMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>

  <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">j</span> <span class="k">in</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">children</span> <span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">children</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;E&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">lookAtMatrix</span><span class="p">.</span><span class="nx">lookAt</span><span class="p">(</span> <span class="nx">eye</span><span class="p">,</span> <span class="nx">vec1</span><span class="p">,</span> <span class="nx">vec2</span> <span class="p">)</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

        <span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">setFromEuler</span><span class="p">(</span> <span class="nx">rotation</span> <span class="p">);</span>

      <span class="p">}</span>

    <span class="p">}</span>

  <span class="p">}</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoTranslate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

  <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">arrowGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">)</span> <span class="p">);</span>
  <span class="nx">mesh</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
  <span class="nx">THREE</span><span class="p">.</span><span class="nx">GeometryUtils</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="nx">mesh</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">lineXGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="nx">lineXGeometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">lineYGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="nx">lineYGeometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">lineZGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="nx">lineZGeometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XYZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">OctahedronGeometry</span><span class="p">(</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XY</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span> <span class="mf">0.29</span><span class="p">,</span> <span class="mf">0.29</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">YZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span> <span class="mf">0.29</span><span class="p">,</span> <span class="mf">0.29</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ffff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.15</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span> <span class="mf">0.29</span><span class="p">,</span> <span class="mf">0.29</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff00ff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.15</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">]</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="nx">lineXGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="nx">lineYGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="nx">lineZGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">]</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XYZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">OctahedronGeometry</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XY</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">YZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ffff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.2</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">PlaneGeometry</span><span class="p">(</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff00ff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">]</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setActivePlane</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">axis</span><span class="p">,</span> <span class="nx">eye</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">tempMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>
    <span class="nx">eye</span><span class="p">.</span><span class="nx">applyProjection</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">extractRotation</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XZ</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">YZ</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span> <span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XZ</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">YZ</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XYZE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;XY&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;YZ&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">YZ</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;XZ&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XZ</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoTranslate</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">);</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoRotate</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

  <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">CircleGeometry</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">radius</span><span class="p">,</span> <span class="nx">facing</span><span class="p">,</span> <span class="nx">arc</span> <span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">geometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
      <span class="nx">arc</span> <span class="o">=</span> <span class="nx">arc</span> <span class="o">?</span> <span class="nx">arc</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">i</span> <span class="o">&lt;=</span> <span class="mi">64</span> <span class="o">*</span> <span class="nx">arc</span><span class="p">;</span> <span class="o">++</span><span class="nx">i</span> <span class="p">)</span> <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">facing</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span> <span class="p">)</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">)</span> <span class="p">).</span><span class="nx">multiplyScalar</span><span class="p">(</span><span class="nx">radius</span><span class="p">)</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">facing</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span> <span class="p">)</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">)</span> <span class="p">).</span><span class="nx">multiplyScalar</span><span class="p">(</span><span class="nx">radius</span><span class="p">)</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">facing</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span> <span class="p">)</span> <span class="nx">geometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">sin</span><span class="p">(</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">cos</span><span class="p">(</span> <span class="nx">i</span> <span class="o">/</span> <span class="mi">32</span> <span class="o">*</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">),</span> <span class="mi">0</span> <span class="p">).</span><span class="nx">multiplyScalar</span><span class="p">(</span><span class="nx">radius</span><span class="p">)</span> <span class="p">);</span>
      <span class="p">}</span>

      <span class="k">return</span> <span class="nx">geometry</span><span class="p">;</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="k">new</span> <span class="nx">CircleGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="k">new</span> <span class="nx">CircleGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="k">new</span> <span class="nx">CircleGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="mf">0.5</span><span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">E</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="k">new</span> <span class="nx">CircleGeometry</span><span class="p">(</span><span class="mf">1.25</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xcccc00</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">XYZE</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="k">new</span> <span class="nx">CircleGeometry</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x787878</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">]</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span> <span class="o">=</span> <span class="p">{};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TorusGeometry</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TorusGeometry</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TorusGeometry</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">E</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TorusGeometry</span><span class="p">(</span> <span class="mf">1.25</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">24</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xffff00</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XYZE</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">()</span> <span class="p">)</span> <span class="c1">// TODO</span>
    <span class="p">]</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setActivePlane</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">axis</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;E&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XYZE</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">YZ</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XZ</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">rotation</span><span class="p">,</span> <span class="nx">eye2</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">prototype</span><span class="p">.</span><span class="nx">update</span><span class="p">.</span><span class="nx">apply</span><span class="p">(</span> <span class="k">this</span><span class="p">,</span> <span class="nx">arguments</span> <span class="p">);</span>

    <span class="kd">var</span> <span class="nx">group</span> <span class="o">=</span> <span class="p">{</span>
      <span class="nx">handles</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">handles</span><span class="p">,</span>
      <span class="nx">pickers</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">pickers</span><span class="p">,</span>
    <span class="p">};</span>

    <span class="kd">var</span> <span class="nx">tempMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">worldRotation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Euler</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">tempQuaternion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">unitX</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">unitY</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">unitZ</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>
    <span class="kd">var</span> <span class="nx">quaternionX</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">quaternionY</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">quaternionZ</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">eye</span> <span class="o">=</span> <span class="nx">eye2</span><span class="p">.</span><span class="nx">clone</span><span class="p">();</span>

    <span class="nx">worldRotation</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">.</span><span class="nx">rotation</span> <span class="p">);</span>
    <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">setFromEuler</span><span class="p">(</span> <span class="nx">worldRotation</span> <span class="p">);</span>

    <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">makeRotationFromQuaternion</span><span class="p">(</span> <span class="nx">tempQuaternion</span> <span class="p">).</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">tempMatrix</span> <span class="p">);</span>
    <span class="nx">eye</span><span class="p">.</span><span class="nx">applyProjection</span><span class="p">(</span> <span class="nx">tempMatrix</span> <span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">group</span> <span class="p">)</span> <span class="p">{</span>

      <span class="k">for</span> <span class="p">(</span> <span class="kd">var</span> <span class="nx">j</span> <span class="k">in</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">children</span> <span class="p">)</span> <span class="p">{</span>

        <span class="kd">var</span> <span class="nx">object</span> <span class="o">=</span> <span class="nx">group</span><span class="p">[</span><span class="nx">i</span><span class="p">].</span><span class="nx">children</span><span class="p">[</span><span class="nx">j</span><span class="p">];</span>

        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">setFromEuler</span><span class="p">(</span> <span class="nx">worldRotation</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">quaternionX</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitX</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="o">-</span><span class="nx">eye</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">eye</span><span class="p">.</span><span class="nx">z</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionX</span> <span class="p">);</span>
          <span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">tempQuaternion</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">quaternionY</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitY</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">eye</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">eye</span><span class="p">.</span><span class="nx">z</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionY</span> <span class="p">);</span>
          <span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">tempQuaternion</span> <span class="p">);</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">object</span><span class="p">.</span><span class="nx">name</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span> <span class="p">)</span> <span class="p">{</span>
          <span class="nx">quaternionZ</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitZ</span><span class="p">,</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">eye</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">eye</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span> <span class="p">);</span>
          <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionZ</span> <span class="p">);</span>
          <span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">tempQuaternion</span> <span class="p">);</span>
        <span class="p">}</span>

      <span class="p">}</span>
    <span class="p">}</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoRotate</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">);</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoScale</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

  <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">arrowGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">mesh</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CubeGeometry</span><span class="p">(</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.125</span> <span class="p">)</span> <span class="p">);</span>
  <span class="nx">mesh</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">;</span>
  <span class="nx">THREE</span><span class="p">.</span><span class="nx">GeometryUtils</span><span class="p">.</span><span class="nx">merge</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="nx">mesh</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">lineXGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="nx">lineXGeometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">lineYGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="nx">lineYGeometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">lineZGeometry</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Geometry</span><span class="p">();</span>
  <span class="nx">lineZGeometry</span><span class="p">.</span><span class="nx">vertices</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">)</span> <span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">handleGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="nx">arrowGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XYZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CubeGeometry</span><span class="p">(</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.125</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">]</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">lineGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="nx">lineXGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="nx">lineYGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Line</span><span class="p">(</span> <span class="nx">lineZGeometry</span><span class="p">,</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoLineMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
    <span class="p">]</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">pickerGizmos</span> <span class="o">=</span> <span class="p">{</span>

    <span class="nx">X</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xff0000</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Y</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x00ff00</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">Z</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CylinderGeometry</span><span class="p">(</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">false</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0x0000ff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mf">0.6</span> <span class="p">),</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">PI</span><span class="o">/</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="p">],</span>
    <span class="nx">XYZ</span><span class="o">:</span> <span class="p">[</span>
      <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Mesh</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">CubeGeometry</span><span class="p">(</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.4</span> <span class="p">),</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoMaterial</span><span class="p">(</span> <span class="p">{</span> <span class="nx">color</span><span class="o">:</span> <span class="mh">0xffffff</span><span class="p">,</span> <span class="nx">opacity</span><span class="o">:</span> <span class="mf">0.25</span> <span class="p">}</span> <span class="p">)</span> <span class="p">)</span>
    <span class="p">]</span>
  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setActivePlane</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">axis</span><span class="p">,</span> <span class="nx">eye</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">tempMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>
    <span class="nx">eye</span><span class="p">.</span><span class="nx">applyProjection</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">extractRotation</span><span class="p">(</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">)</span> <span class="p">)</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="p">{</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XZ</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XY</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">z</span><span class="p">)</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">YZ</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span> <span class="p">){</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XZ</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">abs</span><span class="p">(</span><span class="nx">eye</span><span class="p">.</span><span class="nx">y</span><span class="p">)</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">YZ</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span> <span class="p">)</span> <span class="k">this</span><span class="p">.</span><span class="nx">activePlane</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">planes</span><span class="p">.</span><span class="nx">XYZE</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">show</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">init</span><span class="p">();</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoScale</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmo</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">);</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformControls</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">camera</span><span class="p">,</span> <span class="nx">domElement</span> <span class="p">)</span> <span class="p">{</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>TODO: Make non-uniform scale and rotate play nice in hierarchies
TODO: ADD RXYZ contol</p></div></div><div class="code"><div class="wrapper">  <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span> <span class="k">this</span> <span class="p">);</span>

  <span class="nx">domElement</span> <span class="o">=</span> <span class="p">(</span> <span class="nx">domElement</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="o">?</span> <span class="nx">domElement</span> <span class="o">:</span> <span class="nb">document</span><span class="p">;</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span> <span class="o">=</span> <span class="p">{};</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">translate</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoTranslate</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">rotate</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoRotate</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">scale</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformGizmoScale</span><span class="p">();</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">translate</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">rotate</span><span class="p">);</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">scale</span><span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">translate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">snap</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">space</span> <span class="o">=</span> <span class="s2">&quot;world&quot;</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">this</span><span class="p">.</span><span class="nx">axis</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">scope</span> <span class="o">=</span> <span class="k">this</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">_dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">_mode</span> <span class="o">=</span> <span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="s2">&quot;translate&quot;</span><span class="p">;</span>
  <span class="kd">var</span> <span class="nx">_plane</span> <span class="o">=</span> <span class="s2">&quot;XY&quot;</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">changeEvent</span> <span class="o">=</span> <span class="p">{</span> <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;change&quot;</span> <span class="p">};</span>

  <span class="kd">var</span> <span class="nx">ray</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Raycaster</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">projector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Projector</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">pointerVector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">point</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">offset</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">rotation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">offsetRotation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

  <span class="kd">var</span> <span class="nx">lookAtMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">eye</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">tempMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">tempVector</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">tempQuaternion</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">unitX</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">unitY</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
  <span class="kd">var</span> <span class="nx">unitZ</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">);</span>

  <span class="kd">var</span> <span class="nx">quaternionXYZ</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">quaternionX</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">quaternionY</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">quaternionZ</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">quaternionE</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Quaternion</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">oldPosition</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">oldScale</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">oldRotationMatrix</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">parentRotationMatrix</span>  <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">parentScale</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>

  <span class="kd">var</span> <span class="nx">worldPosition</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">worldRotation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Euler</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">worldRotationMatrix</span>  <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Matrix4</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">camPosition</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Vector3</span><span class="p">();</span>
  <span class="kd">var</span> <span class="nx">camRotation</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Euler</span><span class="p">();</span>

  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;mousedown&quot;</span><span class="p">,</span> <span class="nx">onPointerDown</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;touchstart&quot;</span><span class="p">,</span> <span class="nx">onPointerDown</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;mousemove&quot;</span><span class="p">,</span> <span class="nx">onPointerHover</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;touchmove&quot;</span><span class="p">,</span> <span class="nx">onPointerHover</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;mousemove&quot;</span><span class="p">,</span> <span class="nx">onPointerMove</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;touchmove&quot;</span><span class="p">,</span> <span class="nx">onPointerMove</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;mouseup&quot;</span><span class="p">,</span> <span class="nx">onPointerUp</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;mouseout&quot;</span><span class="p">,</span> <span class="nx">onPointerUp</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;touchend&quot;</span><span class="p">,</span> <span class="nx">onPointerUp</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;touchcancel&quot;</span><span class="p">,</span> <span class="nx">onPointerUp</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>
  <span class="nx">domElement</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span> <span class="s2">&quot;touchleave&quot;</span><span class="p">,</span> <span class="nx">onPointerUp</span><span class="p">,</span> <span class="kc">false</span> <span class="p">);</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">attach</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="nx">object</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">translate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">show</span><span class="p">();</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">detach</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">object</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">axis</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">translate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setMode</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">mode</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">_mode</span> <span class="o">=</span> <span class="nx">mode</span> <span class="o">?</span> <span class="nx">mode</span> <span class="o">:</span> <span class="nx">_mode</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">_mode</span> <span class="o">==</span> <span class="s2">&quot;scale&quot;</span> <span class="p">)</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">=</span> <span class="s2">&quot;local&quot;</span><span class="p">;</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">mode</span> <span class="o">=</span> <span class="nx">_mode</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">translate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">rotate</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">hide</span><span class="p">();</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">show</span><span class="p">();</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span> <span class="nx">changeEvent</span> <span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setSnap</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">snap</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span> <span class="o">=</span> <span class="nx">snap</span><span class="p">;</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setSize</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">size</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">size</span> <span class="o">=</span> <span class="nx">size</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span> <span class="nx">changeEvent</span> <span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">setSpace</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">(</span> <span class="nx">space</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">=</span> <span class="nx">space</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span> <span class="nx">changeEvent</span> <span class="p">);</span>

  <span class="p">};</span>

  <span class="k">this</span><span class="p">.</span><span class="nx">update</span> <span class="o">=</span> <span class="kd">function</span> <span class="p">()</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">updateMatrixWorld</span><span class="p">();</span>
    <span class="nx">worldPosition</span><span class="p">.</span><span class="nx">setFromMatrixPosition</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">);</span>
    <span class="nx">worldRotation</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">extractRotation</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">)</span> <span class="p">);</span>

    <span class="nx">camera</span><span class="p">.</span><span class="nx">updateMatrixWorld</span><span class="p">();</span>
    <span class="nx">camPosition</span><span class="p">.</span><span class="nx">setFromMatrixPosition</span><span class="p">(</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">);</span>
    <span class="nx">camRotation</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">extractRotation</span><span class="p">(</span> <span class="nx">camera</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">)</span> <span class="p">);</span>

    <span class="nx">scale</span> <span class="o">=</span> <span class="nx">worldPosition</span><span class="p">.</span><span class="nx">distanceTo</span><span class="p">(</span> <span class="nx">camPosition</span> <span class="p">)</span> <span class="o">/</span> <span class="mi">6</span> <span class="o">*</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">size</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">worldPosition</span> <span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">scale</span><span class="p">,</span> <span class="nx">scale</span><span class="p">,</span> <span class="nx">scale</span> <span class="p">);</span>

    <span class="nx">eye</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">camPosition</span> <span class="p">).</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">worldPosition</span> <span class="p">).</span><span class="nx">normalize</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">update</span><span class="p">(</span> <span class="nx">worldRotation</span><span class="p">,</span> <span class="nx">eye</span> <span class="p">);</span>

    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span> <span class="p">)</span>
      <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">update</span><span class="p">(</span> <span class="k">new</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Euler</span><span class="p">(),</span> <span class="nx">eye</span> <span class="p">);</span>

    <span class="k">this</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">highlight</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="p">);</span>

  <span class="p">};</span>

  <span class="kd">function</span> <span class="nx">onPointerHover</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">_dragging</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>

    <span class="kd">var</span> <span class="nx">pointer</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">touches</span> <span class="o">?</span> <span class="nx">event</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">:</span> <span class="nx">event</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">intersect</span> <span class="o">=</span> <span class="nx">intersectObjects</span><span class="p">(</span> <span class="nx">pointer</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">pickers</span><span class="p">.</span><span class="nx">children</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">intersect</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">=</span> <span class="nx">intersect</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>
      <span class="nx">scope</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
      <span class="nx">scope</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span> <span class="nx">changeEvent</span> <span class="p">);</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">=</span> <span class="kc">undefined</span><span class="p">;</span>
      <span class="nx">scope</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
      <span class="nx">scope</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span> <span class="nx">changeEvent</span> <span class="p">);</span>

    <span class="p">}</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onPointerDown</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">_dragging</span> <span class="o">===</span> <span class="kc">true</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>event.stopPropagation();</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">pointer</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">touches</span> <span class="o">?</span> <span class="nx">event</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">:</span> <span class="nx">event</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">pointer</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="mi">0</span> <span class="o">||</span> <span class="nx">pointer</span><span class="p">.</span><span class="nx">button</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

      <span class="kd">var</span> <span class="nx">intersect</span> <span class="o">=</span> <span class="nx">intersectObjects</span><span class="p">(</span> <span class="nx">pointer</span><span class="p">,</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">pickers</span><span class="p">.</span><span class="nx">children</span> <span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">intersect</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">=</span> <span class="nx">intersect</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">name</span><span class="p">;</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>

        <span class="nx">eye</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">camPosition</span> <span class="p">).</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">worldPosition</span> <span class="p">).</span><span class="nx">normalize</span><span class="p">();</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">setActivePlane</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">,</span> <span class="nx">eye</span> <span class="p">);</span>

        <span class="kd">var</span> <span class="nx">planeIntersect</span> <span class="o">=</span> <span class="nx">intersectObjects</span><span class="p">(</span> <span class="nx">pointer</span><span class="p">,</span> <span class="p">[</span><span class="nx">scope</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">activePlane</span><span class="p">]</span> <span class="p">);</span>

        <span class="nx">oldPosition</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span> <span class="p">);</span>
        <span class="nx">oldScale</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">scale</span> <span class="p">);</span>

        <span class="nx">oldRotationMatrix</span><span class="p">.</span><span class="nx">extractRotation</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">matrix</span> <span class="p">);</span>
        <span class="nx">worldRotationMatrix</span><span class="p">.</span><span class="nx">extractRotation</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">);</span>

        <span class="nx">parentRotationMatrix</span><span class="p">.</span><span class="nx">extractRotation</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">);</span>
        <span class="nx">parentScale</span><span class="p">.</span><span class="nx">setFromMatrixScale</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">parent</span><span class="p">.</span><span class="nx">matrixWorld</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">offset</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">planeIntersect</span><span class="p">.</span><span class="nx">point</span> <span class="p">);</span>

      <span class="p">}</span>

    <span class="p">}</span>

    <span class="nx">_dragging</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onPointerMove</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">===</span> <span class="kc">undefined</span> <span class="o">||</span> <span class="nx">_dragging</span> <span class="o">===</span> <span class="kc">false</span> <span class="p">)</span> <span class="k">return</span><span class="p">;</span>

    <span class="nx">event</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span></div></div></div><div class="segment"><div class="comments "><div class="wrapper"><p>event.stopPropagation();</p></div></div><div class="code"><div class="wrapper">    <span class="kd">var</span> <span class="nx">pointer</span> <span class="o">=</span> <span class="nx">event</span><span class="p">.</span><span class="nx">touches</span><span class="o">?</span> <span class="nx">event</span><span class="p">.</span><span class="nx">touches</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="nx">event</span><span class="p">;</span>

    <span class="kd">var</span> <span class="nx">planeIntersect</span> <span class="o">=</span> <span class="nx">intersectObjects</span><span class="p">(</span> <span class="nx">pointer</span><span class="p">,</span> <span class="p">[</span><span class="nx">scope</span><span class="p">.</span><span class="nx">gizmo</span><span class="p">[</span><span class="nx">_mode</span><span class="p">].</span><span class="nx">activePlane</span><span class="p">]</span> <span class="p">);</span>

    <span class="nx">point</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">planeIntersect</span><span class="p">.</span><span class="nx">point</span> <span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span> <span class="nx">_mode</span> <span class="o">==</span> <span class="s2">&quot;translate&quot;</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">point</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">offset</span> <span class="p">);</span>
      <span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">parentScale</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">point</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">worldRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">point</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">oldRotationMatrix</span> <span class="p">);</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">oldPosition</span> <span class="p">);</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">point</span> <span class="p">);</span>

      <span class="p">}</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span> <span class="o">||</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;XYZ&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="nx">point</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">parentRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">oldPosition</span> <span class="p">);</span>
        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span> <span class="nx">point</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span> <span class="o">!==</span> <span class="kc">undefined</span> <span class="p">)</span> <span class="p">{</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;X&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">x</span> <span class="o">/</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span> <span class="p">)</span> <span class="o">*</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;Y&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">y</span> <span class="o">/</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span> <span class="p">)</span> <span class="o">*</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span><span class="p">;</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span><span class="p">.</span><span class="nx">search</span><span class="p">(</span><span class="s2">&quot;Z&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">round</span><span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">position</span><span class="p">.</span><span class="nx">z</span> <span class="o">/</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span> <span class="p">)</span> <span class="o">*</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">snap</span><span class="p">;</span>

        <span class="p">}</span>

      <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">_mode</span> <span class="o">==</span> <span class="s2">&quot;scale&quot;</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">point</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">offset</span> <span class="p">);</span>
      <span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">parentScale</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="p">)</span> <span class="p">{</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;XYZ&quot;</span><span class="p">)</span> <span class="p">{</span>

          <span class="nx">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="p">(</span> <span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="p">)</span> <span class="p">);</span>

          <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">oldScale</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="nx">scale</span><span class="p">;</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">oldScale</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="nx">scale</span><span class="p">;</span>
          <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">oldScale</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="nx">scale</span><span class="p">;</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

          <span class="nx">point</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">worldRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>

          <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">x</span> <span class="o">=</span> <span class="nx">oldScale</span><span class="p">.</span><span class="nx">x</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="p">)</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">y</span> <span class="o">=</span> <span class="nx">oldScale</span><span class="p">.</span><span class="nx">y</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>
          <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span> <span class="p">)</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">scale</span><span class="p">.</span><span class="nx">z</span> <span class="o">=</span> <span class="nx">oldScale</span><span class="p">.</span><span class="nx">z</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span> <span class="o">+</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span> <span class="p">);</span>

        <span class="p">}</span>

      <span class="p">}</span>

    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">_mode</span> <span class="o">==</span> <span class="s2">&quot;rotate&quot;</span> <span class="p">)</span> <span class="p">{</span>

      <span class="nx">point</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">worldPosition</span> <span class="p">);</span>
      <span class="nx">point</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">parentScale</span><span class="p">);</span>
      <span class="nx">tempVector</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span><span class="nx">offset</span><span class="p">).</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">worldPosition</span> <span class="p">);</span>
      <span class="nx">tempVector</span><span class="p">.</span><span class="nx">multiply</span><span class="p">(</span><span class="nx">parentScale</span><span class="p">);</span>

      <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;E&quot;</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">point</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">lookAtMatrix</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">tempVector</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">lookAtMatrix</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">y</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">z</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">parentRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">quaternionE</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">eye</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">z</span> <span class="p">);</span>
        <span class="nx">quaternionXYZ</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">worldRotationMatrix</span> <span class="p">);</span>

        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionE</span> <span class="p">);</span>
        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionXYZ</span> <span class="p">);</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">tempQuaternion</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;XYZE&quot;</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">quaternionE</span><span class="p">.</span><span class="nx">setFromEuler</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">cross</span><span class="p">(</span><span class="nx">tempVector</span><span class="p">).</span><span class="nx">normalize</span><span class="p">()</span> <span class="p">);</span> <span class="c1">// rotation axis</span>

        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">parentRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">quaternionX</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">quaternionE</span><span class="p">,</span> <span class="o">-</span> <span class="nx">point</span><span class="p">.</span><span class="nx">clone</span><span class="p">().</span><span class="nx">angleTo</span><span class="p">(</span><span class="nx">tempVector</span><span class="p">)</span> <span class="p">);</span>
        <span class="nx">quaternionXYZ</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">worldRotationMatrix</span> <span class="p">);</span>

        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionX</span> <span class="p">);</span>
        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionXYZ</span> <span class="p">);</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">tempQuaternion</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">==</span> <span class="s2">&quot;local&quot;</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">point</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">worldRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">tempVector</span><span class="p">.</span><span class="nx">applyMatrix4</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">worldRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">y</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">z</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">quaternionXYZ</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">oldRotationMatrix</span> <span class="p">);</span>
        <span class="nx">quaternionX</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitX</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">x</span> <span class="p">);</span>
        <span class="nx">quaternionY</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitY</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>
        <span class="nx">quaternionZ</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitZ</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">z</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="nx">quaternionXYZ</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">quaternionXYZ</span><span class="p">,</span> <span class="nx">quaternionX</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="p">)</span> <span class="nx">quaternionXYZ</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">quaternionXYZ</span><span class="p">,</span> <span class="nx">quaternionY</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span> <span class="p">)</span> <span class="nx">quaternionXYZ</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">quaternionXYZ</span><span class="p">,</span> <span class="nx">quaternionZ</span> <span class="p">);</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">quaternionXYZ</span> <span class="p">);</span>

      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">space</span> <span class="o">==</span> <span class="s2">&quot;world&quot;</span> <span class="p">)</span> <span class="p">{</span>

        <span class="nx">rotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">z</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">point</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">point</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span> <span class="p">);</span>
        <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">z</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">y</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">x</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">z</span> <span class="p">),</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">atan2</span><span class="p">(</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">y</span><span class="p">,</span> <span class="nx">tempVector</span><span class="p">.</span><span class="nx">x</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">tempMatrix</span><span class="p">.</span><span class="nx">getInverse</span><span class="p">(</span> <span class="nx">parentRotationMatrix</span> <span class="p">)</span> <span class="p">);</span>

        <span class="nx">quaternionX</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitX</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">.</span><span class="nx">x</span> <span class="o">-</span> <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">x</span> <span class="p">);</span>
        <span class="nx">quaternionY</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitY</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">.</span><span class="nx">y</span> <span class="o">-</span> <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">y</span> <span class="p">);</span>
        <span class="nx">quaternionZ</span><span class="p">.</span><span class="nx">setFromAxisAngle</span><span class="p">(</span> <span class="nx">unitZ</span><span class="p">,</span> <span class="nx">rotation</span><span class="p">.</span><span class="nx">z</span> <span class="o">-</span> <span class="nx">offsetRotation</span><span class="p">.</span><span class="nx">z</span> <span class="p">);</span>
        <span class="nx">quaternionXYZ</span><span class="p">.</span><span class="nx">setFromRotationMatrix</span><span class="p">(</span> <span class="nx">worldRotationMatrix</span> <span class="p">);</span>

        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;X&quot;</span> <span class="p">)</span> <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionX</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Y&quot;</span> <span class="p">)</span> <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionY</span> <span class="p">);</span>
        <span class="k">if</span> <span class="p">(</span> <span class="nx">scope</span><span class="p">.</span><span class="nx">axis</span> <span class="o">==</span> <span class="s2">&quot;Z&quot;</span> <span class="p">)</span> <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionZ</span> <span class="p">);</span>

        <span class="nx">tempQuaternion</span><span class="p">.</span><span class="nx">multiplyQuaternions</span><span class="p">(</span> <span class="nx">tempQuaternion</span><span class="p">,</span> <span class="nx">quaternionXYZ</span> <span class="p">);</span>

        <span class="nx">scope</span><span class="p">.</span><span class="nx">object</span><span class="p">.</span><span class="nx">quaternion</span><span class="p">.</span><span class="nx">copy</span><span class="p">(</span> <span class="nx">tempQuaternion</span> <span class="p">);</span>

      <span class="p">}</span>

    <span class="p">}</span>

    <span class="nx">scope</span><span class="p">.</span><span class="nx">update</span><span class="p">();</span>
    <span class="nx">scope</span><span class="p">.</span><span class="nx">dispatchEvent</span><span class="p">(</span> <span class="nx">changeEvent</span> <span class="p">);</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">onPointerUp</span><span class="p">(</span> <span class="nx">event</span> <span class="p">)</span> <span class="p">{</span>

    <span class="nx">_dragging</span> <span class="o">=</span> <span class="kc">false</span><span class="p">;</span>
    <span class="nx">onPointerHover</span><span class="p">(</span> <span class="nx">event</span> <span class="p">);</span>

  <span class="p">}</span>

  <span class="kd">function</span> <span class="nx">intersectObjects</span><span class="p">(</span> <span class="nx">pointer</span><span class="p">,</span> <span class="nx">objects</span> <span class="p">)</span> <span class="p">{</span>

    <span class="kd">var</span> <span class="nx">rect</span> <span class="o">=</span> <span class="nx">domElement</span><span class="p">.</span><span class="nx">getBoundingClientRect</span><span class="p">();</span>
    <span class="kd">var</span> <span class="nx">x</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pointer</span><span class="p">.</span><span class="nx">clientX</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">left</span><span class="p">)</span> <span class="o">/</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">width</span><span class="p">;</span>
    <span class="kd">var</span> <span class="nx">y</span> <span class="o">=</span> <span class="p">(</span><span class="nx">pointer</span><span class="p">.</span><span class="nx">clientY</span> <span class="o">-</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">top</span><span class="p">)</span> <span class="o">/</span> <span class="nx">rect</span><span class="p">.</span><span class="nx">height</span><span class="p">;</span>
    <span class="nx">pointerVector</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="p">(</span> <span class="nx">x</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">-</span> <span class="p">(</span> <span class="nx">y</span> <span class="p">)</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mf">0.5</span> <span class="p">);</span>

    <span class="nx">projector</span><span class="p">.</span><span class="nx">unprojectVector</span><span class="p">(</span> <span class="nx">pointerVector</span><span class="p">,</span> <span class="nx">camera</span> <span class="p">);</span>
    <span class="nx">ray</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span> <span class="nx">camPosition</span><span class="p">,</span> <span class="nx">pointerVector</span><span class="p">.</span><span class="nx">sub</span><span class="p">(</span> <span class="nx">camPosition</span> <span class="p">).</span><span class="nx">normalize</span><span class="p">()</span> <span class="p">);</span>

    <span class="kd">var</span> <span class="nx">intersections</span> <span class="o">=</span> <span class="nx">ray</span><span class="p">.</span><span class="nx">intersectObjects</span><span class="p">(</span> <span class="nx">objects</span><span class="p">,</span> <span class="kc">true</span> <span class="p">);</span>
    <span class="k">return</span> <span class="nx">intersections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">?</span> <span class="nx">intersections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">:</span> <span class="kc">false</span><span class="p">;</span>

  <span class="p">}</span>

<span class="p">};</span>

<span class="nx">THREE</span><span class="p">.</span><span class="nx">TransformControls</span><span class="p">.</span><span class="nx">prototype</span> <span class="o">=</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">create</span><span class="p">(</span> <span class="nx">THREE</span><span class="p">.</span><span class="nx">Object3D</span><span class="p">.</span><span class="nx">prototype</span> <span class="p">);</span>
<span class="p">})(</span><span class="nx">THREE</span><span class="p">);</span></div></div></div></div></body></html>